from flask import Flask, jsonify
import numpy as np
import cv2
import matplotlib.pyplot as plt
import time
import requests
import pyautogui

app = Flask(__name__)


@app.route("/opencamera")
def openCamera(link):
    link = 'http: // ezvizportal - 1414028875.us-east.elb.amazonaws.com/help/service/pc/login.html'
    linkCamera = ''

    req = requests.get(link)
    reqCam = requests.get(linkCamera)
    imagemTreino = pyautogui.screenshot()


@app.route("/detect")
def detectFaces(arquivoTreino, imagemTreino,  scaleFactor=1.1):
    arq = cv2.CascadeClassifier(arquivoTreino)
    img_copy = np.copy(imagemTreino)
    gray = cv2.cvtColor(img_copy,cv2.COLOR_BGR2GRAY)     #every image has to be gray for openCv

    plt.imshow(gray, cmap='gray') #show the image

    faces = arq.DetectMultiScale(gray, scaleFactor = 1.1, minNeighbors = 5)
    print('Faces found: ', len(faces))

    for (x, y, w, h) in faces:
        cv2.retangle(img_copy, (x,y),(x + w, y + h), (0, 255, 0), 2)
        if len(faces) < 30:      #if there should be 30 students
            presNum = int(len(faces))
            presPct = presNum *100/30
            faltNum = int(presNum - 30)
            faltPct = faltNum *100/30
            output = {'Present students' : presNum, 'Present students %' : presPct, 'Absent students' : faltNum, 'Absent students %' : faltPct }

            print(output)
            return jsonify(output)
        else:
            output = {'Present students' : 'all students present'}

            print(output)
            return jsonify(output)
            return img_copy

app.run(host = '0.0.0.0')
